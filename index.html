<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/index.css" />
<title>MetaX Deck Builder</title>

<body>
<script src="/elm.js"></script>
<script>
	var app = Elm.Main.fullscreen(localStorage.session || null);

	app.ports.storeSession.subscribe(function(session) {
		localStorage.session = session;
	});

	app.ports.exportSession.subscribe(function(session) {
		var decklist = JSON.parse(session);
		var doc = new jsPDF({ format: 'letter' });

		// TODO: This should probably be done in Elm!
		var characters = decklist.filter(function(card) {
			return card.card_type === 'Character';
		});
		var characterSum = characters.reduce(function(sum, card) {
			return (sum + card.quantity);
		}, 0);

		var battle = decklist.filter(function(card) {
			return card.card_type === 'Battle';
		});
		var battleSum = battle.reduce(function(sum, card) {
			return (sum + card.quantity);
		}, 0);

		var events = decklist.filter(function(card) {
			return card.card_type === 'Event';
		});
		var eventSum = events.reduce(function(sum, card) {
			return (sum + card.quantity);
		}, 0);

		function toLine(card, idx) {
			var line = card.quantity + 'x ' + card.title + ' (' + card.id + ')';
			return line;
		}

		var characterLines = characters.map(toLine);
		var battleLines = battle.map(toLine);
		var eventLines = events.map(toLine);

		var lines = []

		if (characterLines.length) {
			lines = lines.concat(['Characters (' + characterSum + ')'], characterLines);
		}

		if (battleLines.length) {
			lines = lines.concat(['', 'Battle Cards (' + battleSum + ')'], battleLines);
		}

		if (eventLines.length) {
			lines = lines.concat(['', 'Events (' + eventSum + ')'], eventLines);
		}

		doc.text(25, 25, lines);
		doc.save('metax-deck.pdf');
	});

	window.addEventListener("storage", function(event) {
		if (event.storageArea === localStorage && event.key === "session") {
			app.ports.onSessionChange.send(event.newValue);
		}
	}, false);
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>
</body>
